<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SyncLiked - Spotify Playlist Manager</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        spotify: '#1db954',
                        'spotify-hover': '#1ed760'
                    }
                }
            }
        }
    </script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Simple UI Components
        const Button = ({ children, onClick, disabled, className, type = "button", variant = "default" }) => {
            const baseClasses = "px-4 py-2 rounded-lg font-medium transition-all duration-200 min-h-[44px] flex items-center justify-center gap-2";
            const variants = {
                default: "bg-[#1db954] hover:bg-[#1ed760] text-white hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100",
                outline: "border border-gray-600 text-white hover:bg-gray-800 hover:border-gray-500 bg-transparent",
                ghost: "text-[#1db954] hover:text-[#1ed760] hover:bg-[#1db954]/10 bg-transparent border-none"
            };
            
            return (
                <button 
                    type={type}
                    onClick={onClick} 
                    disabled={disabled}
                    className={`${baseClasses} ${variants[variant]} ${className || ''}`}
                >
                    {children}
                </button>
            );
        };

        const Card = ({ children, className }) => (
            <div className={`bg-[#1e1e1e] border border-gray-800 rounded-lg ${className || ''}`}>
                {children}
            </div>
        );

        const Input = ({ value, onChange, placeholder, type = "text", required, className, id }) => (
            <input
                id={id}
                type={type}
                value={value}
                onChange={onChange}
                placeholder={placeholder}
                required={required}
                className={`w-full px-3 py-2 bg-[#121212] border border-gray-700 rounded-md text-white placeholder-gray-500 focus:border-[#1db954] focus:outline-none ${className || ''}`}
            />
        );

        const Checkbox = ({ checked, onChange, id }) => (
            <input
                id={id}
                type="checkbox"
                checked={checked}
                onChange={(e) => onChange(e.target.checked)}
                className="w-4 h-4 text-[#1db954] bg-gray-700 border-gray-600 rounded focus:ring-[#1db954] focus:ring-2"
            />
        );

        // Icons as simple SVGs
        const LogInIcon = () => (
            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1" />
            </svg>
        );

        const LoaderIcon = () => (
            <svg className="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24">
                <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                <path className="opacity-75" fill="currentColor" d="m4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
        );

        const ChevronDownIcon = () => (
            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
            </svg>
        );

        const ChevronUpIcon = () => (
            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 15l7-7 7 7" />
            </svg>
        );

        const ExternalLinkIcon = () => (
            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
            </svg>
        );

        const SpotifyMusicManager = () => {
            const [isAdvancedOpen, setIsAdvancedOpen] = useState(false);
            const [isLoading, setIsLoading] = useState(false);
            const [isLoggedIn, setIsLoggedIn] = useState(false);
            const [result, setResult] = useState(null);
            const [formData, setFormData] = useState({
                playlistName: "My Liked Songs",
                isPublic: false,
                songLimit: "",
            });

            // Spotify OAuth Configuration
            const SPOTIFY_CONFIG = {
                client_id: '6aa4b46ee49d40a292632af532a593b3',
                redirect_uri: 'http://127.0.0.1:3000/callback.html',
                scope: 'user-library-read playlist-modify-private playlist-modify-public'
            };

            // Check if user is logged in on component mount
            useEffect(() => {
                const token = localStorage.getItem('access_token');
                setIsLoggedIn(!!token);

                // Handle OAuth callback
                const urlParams = new URLSearchParams(window.location.search);
                const code = urlParams.get('code');
                
                if (code && !token) {
                    handleOAuthCallback(code);
                }
            }, []);

            // Handle OAuth login
            const handleLogin = () => {
                const authUrl = `https://accounts.spotify.com/authorize?` +
                    `response_type=code&` +
                    `client_id=${SPOTIFY_CONFIG.client_id}&` +
                    `scope=${encodeURIComponent(SPOTIFY_CONFIG.scope)}&` +
                    `redirect_uri=${encodeURIComponent(SPOTIFY_CONFIG.redirect_uri)}`;
                
                window.location.href = authUrl;
            };

            // Handle OAuth callback
            const handleOAuthCallback = async (code) => {
                try {
                    const response = await fetch('https://accounts.spotify.com/api/token', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'Authorization': 'Basic ' + btoa(`${SPOTIFY_CONFIG.client_id}:d59645a4c1ae4313a892f62a3abbabf7`)
                        },
                        body: new URLSearchParams({
                            grant_type: 'authorization_code',
                            code: code,
                            redirect_uri: SPOTIFY_CONFIG.redirect_uri
                        })
                    });

                    const data = await response.json();
                    
                    if (data.access_token) {
                        localStorage.setItem('access_token', data.access_token);
                        setIsLoggedIn(true);
                        window.history.replaceState({}, document.title, window.location.pathname);
                    }
                } catch (error) {
                    console.error('OAuth callback error:', error);
                }
            };

            // Handle logout
            const handleLogout = () => {
                localStorage.removeItem('access_token');
                setIsLoggedIn(false);
                setResult(null);
            };

            // Main transfer function
            const handleSubmit = async (e) => {
                e.preventDefault();
                
                if (!isLoggedIn) {
                    setResult({
                        type: "error",
                        message: "Please login with Spotify first."
                    });
                    return;
                }

                setIsLoading(true);
                setResult(null);

                try {
                    const token = localStorage.getItem('access_token');
                    const headers = { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    };

                    // 1. Get User ID
                    const userResponse = await fetch('https://api.spotify.com/v1/me', { headers });
                    const user = await userResponse.json();

                    if (!userResponse.ok) {
                        throw new Error('Failed to get user information');
                    }

                    // 2. Create Playlist
                    const playlistResponse = await fetch(`https://api.spotify.com/v1/users/${user.id}/playlists`, {
                        method: 'POST',
                        headers,
                        body: JSON.stringify({
                            name: formData.playlistName,
                            description: `Auto-created from Liked Songs on ${new Date().toLocaleDateString()}`,
                            public: formData.isPublic
                        })
                    });

                    const playlist = await playlistResponse.json();

                    if (!playlistResponse.ok) {
                        throw new Error('Failed to create playlist');
                    }

                    // 3. Fetch Liked Songs
                    let offset = 0;
                    let uris = [];
                    const songLimit = formData.songLimit ? parseInt(formData.songLimit) : null;

                    while (true) {
                        const tracksResponse = await fetch(
                            `https://api.spotify.com/v1/me/tracks?limit=50&offset=${offset}`,
                            { headers }
                        );
                        const tracksData = await tracksResponse.json();

                        if (!tracksResponse.ok) {
                            throw new Error('Failed to fetch liked songs');
                        }

                        const newUris = tracksData.items.map(item => item.track.uri);
                        uris.push(...newUris);

                        if (tracksData.items.length < 50) break;
                        if (songLimit && uris.length >= songLimit) {
                            uris = uris.slice(0, songLimit);
                            break;
                        }
                        offset += 50;
                    }

                    // 4. Add Songs to Playlist (100 at a time)
                    const batchSize = 100;
                    for (let i = 0; i < uris.length; i += batchSize) {
                        const batch = uris.slice(i, i + batchSize);
                        
                        const addResponse = await fetch(`https://api.spotify.com/v1/playlists/${playlist.id}/tracks`, {
                            method: 'POST',
                            headers,
                            body: JSON.stringify({ uris: batch })
                        });

                        if (!addResponse.ok) {
                            throw new Error('Failed to add songs to playlist');
                        }
                    }

                    setResult({
                        type: "success",
                        message: `Successfully created "${formData.playlistName}"!`,
                        link: playlist.external_urls.spotify,
                        tracks: uris.length
                    });

                } catch (error) {
                    setResult({
                        type: "error",
                        message: error.message || "An error occurred while creating the playlist."
                    });
                } finally {
                    setIsLoading(false);
                }
            };

            return (
                <div className="min-h-screen bg-[#121212] text-white">
                    {/* Header */}
                    <header className="bg-gradient-to-br from-[#1e1e1e] via-[#121212] to-[#0a0a0a] border-b border-gray-800 relative overflow-hidden">
                        <div className="absolute inset-0 bg-gradient-to-r from-transparent via-[#1db954]/5 to-transparent"></div>
                        <div className="relative max-w-6xl mx-auto px-4 py-8">
                            <div className="text-center">
                                <h1 className="text-4xl font-bold mb-2 flex items-center justify-center gap-3 bg-gradient-to-r from-white via-gray-100 to-[#1db954] bg-clip-text text-transparent">
                                    🎵 SyncLiked
                                </h1>
                                <p className="text-gray-400 text-lg">Instantly convert your liked songs into a custom playlist!</p>
                            </div>
                            
                            {/* Login/Logout Button */}
                            <div className="flex justify-center mt-6">
                                {isLoggedIn ? (
                                    <Button onClick={handleLogout} variant="outline">
                                        Logout from Spotify
                                    </Button>
                                ) : (
                                    <Button onClick={handleLogin} className="rounded-[25px] py-3 px-8">
                                        <LogInIcon /> Login with Spotify
                                    </Button>
                                )}
                            </div>
                        </div>
                    </header>

                    <main className="max-w-6xl mx-auto px-4 py-8">
                        {/* Feature Cards */}
                        <section className="mb-12">
                            <h2 className="text-2xl font-bold text-center mb-8">Why Choose SyncLiked?</h2>
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <Card className="hover:border-[#1db954] transition-colors duration-300">
                                    <div className="p-6 text-center">
                                        <div className="flex justify-center mb-4 text-[#1db954] text-4xl">📁</div>
                                        <h3 className="text-white text-xl font-semibold mb-2">Organize</h3>
                                        <p className="text-gray-400">Turn your massive liked songs collection into organized playlists</p>
                                    </div>
                                </Card>
                                <Card className="hover:border-[#1db954] transition-colors duration-300">
                                    <div className="p-6 text-center">
                                        <div className="flex justify-center mb-4 text-[#1db954] text-4xl">📤</div>
                                        <h3 className="text-white text-xl font-semibold mb-2">Share</h3>
                                        <p className="text-gray-400">Make your favorite music shareable with friends</p>
                                    </div>
                                </Card>
                                <Card className="hover:border-[#1db954] transition-colors duration-300">
                                    <div className="p-6 text-center">
                                        <div className="flex justify-center mb-4 text-[#1db954] text-4xl">⚡</div>
                                        <h3 className="text-white text-xl font-semibold mb-2">Fast</h3>
                                        <p className="text-gray-400">Transfer hundreds of songs in seconds</p>
                                    </div>
                                </Card>
                            </div>
                        </section>

                        {/* Main Form */}
                        {isLoggedIn && (
                            <section className="mb-8">
                                <Card>
                                    <div className="p-6">
                                        <h3 className="text-white text-xl font-semibold mb-2">Transfer Liked Songs to Playlist</h3>
                                        <p className="text-gray-400 mb-6">Create a new playlist from your liked songs with custom preferences</p>
                                        
                                        <form onSubmit={handleSubmit} className="space-y-6">
                                            <div className="space-y-2">
                                                <label htmlFor="playlistName" className="text-white block">Playlist Name *</label>
                                                <Input
                                                    id="playlistName"
                                                    type="text"
                                                    placeholder="Enter playlist name..."
                                                    value={formData.playlistName}
                                                    onChange={(e) => setFormData(prev => ({ ...prev, playlistName: e.target.value }))}
                                                    required
                                                />
                                            </div>

                                            {/* Advanced Options */}
                                            <div className="border-t border-gray-700 pt-6">
                                                <Button
                                                    type="button"
                                                    variant="ghost"
                                                    onClick={() => setIsAdvancedOpen(!isAdvancedOpen)}
                                                    className="p-0 h-auto font-medium"
                                                >
                                                    Advanced Options
                                                    {isAdvancedOpen ? <ChevronUpIcon /> : <ChevronDownIcon />}
                                                </Button>

                                                {isAdvancedOpen && (
                                                    <div className="mt-4 space-y-4 p-4 bg-[#121212] rounded-lg border border-gray-700">
                                                        <div className="flex items-center space-x-2">
                                                            <Checkbox
                                                                id="isPublic"
                                                                checked={formData.isPublic}
                                                                onChange={(checked) => setFormData(prev => ({ ...prev, isPublic: checked }))}
                                                            />
                                                            <label htmlFor="isPublic" className="text-white text-sm">Make playlist public</label>
                                                        </div>

                                                        <div className="space-y-2">
                                                            <label htmlFor="songLimit" className="text-white text-sm block">Limit number of songs (optional)</label>
                                                            <Input
                                                                id="songLimit"
                                                                type="number"
                                                                placeholder="Leave empty for all songs"
                                                                value={formData.songLimit}
                                                                onChange={(e) => setFormData(prev => ({ ...prev, songLimit: e.target.value }))}
                                                                className="bg-[#0a0a0a] border-gray-600"
                                                            />
                                                        </div>
                                                    </div>
                                                )}
                                            </div>

                                            {/* Action Buttons */}
                                            <div className="flex flex-col sm:flex-row gap-3 pt-4">
                                                <Button
                                                    type="submit"
                                                    disabled={isLoading}
                                                    className="rounded-[25px] py-3 px-8"
                                                >
                                                    {isLoading ? (
                                                        <>
                                                            <LoaderIcon />
                                                            Creating Playlist...
                                                        </>
                                                    ) : (
                                                        "Transfer Liked Songs to Playlist"
                                                    )}
                                                </Button>

                                                <Button
                                                    type="button"
                                                    variant="outline"
                                                    className="rounded-[25px] py-3 px-8"
                                                    onClick={() => {
                                                        setFormData({
                                                            playlistName: "My Liked Songs",
                                                            isPublic: false,
                                                            songLimit: "",
                                                        });
                                                        setResult(null);
                                                    }}
                                                >
                                                    Reset Form
                                                </Button>
                                            </div>
                                        </form>
                                    </div>
                                </Card>
                            </section>
                        )}

                        {/* Results Section */}
                        {result && (
                            <section className="mb-8">
                                <Card className={`border-2 ${
                                    result.type === "success" ? "bg-green-900/20 border-green-600" : "bg-red-900/20 border-red-600"
                                }`}>
                                    <div className="p-6">
                                        <div className="flex items-center justify-between flex-wrap gap-4">
                                            <div>
                                                <p className={`font-medium ${result.type === "success" ? "text-green-400" : "text-red-400"}`}>
                                                    {result.message}
                                                </p>
                                                {result.tracks && (
                                                    <p className="text-gray-400 text-sm mt-1">
                                                        Transferred {result.tracks} tracks successfully
                                                    </p>
                                                )}
                                            </div>
                                            {result.link && (
                                                <Button
                                                    variant="ghost" 
                                                    onClick={() => window.open(result.link, '_blank')}
                                                    className="text-sm"
                                                >
                                                    Open in Spotify <ExternalLinkIcon />
                                                </Button>
                                            )}
                                        </div>
                                    </div>
                                </Card>
                            </section>
                        )}

                        {/* Login Prompt */}
                        {!isLoggedIn && (
                            <section className="mb-8">
                                <Card>
                                    <div className="p-6 text-center">
                                        <p className="text-gray-400 mb-4">
                                            Please login with your Spotify account to start transferring your liked songs.
                                        </p>
                                        <Button onClick={handleLogin} className="rounded-[25px] py-3 px-8">
                                            <LogInIcon /> Login with Spotify
                                        </Button>
                                    </div>
                                </Card>
                            </section>
                        )}
                    </main>
                </div>
            );
        };

        // Render the app
        ReactDOM.render(<SpotifyMusicManager />, document.getElementById('root'));
    </script>
</body>
</html>
